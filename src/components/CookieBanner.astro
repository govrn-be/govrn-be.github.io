---
// Note: Add i18n support later if needed
// import { getLangFromUrl, useTranslations } from '../i18n/utils';
// const lang = getLangFromUrl(Astro.url);
// const t = useTranslations(lang);
---

<div id="cookie-banner" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50 transform translate-y-full transition-transform duration-300 hidden">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div class="flex-1">
        <p class="text-sm text-gray-600 leading-relaxed">
          We use cookies to enhance your browsing experience, serve personalized content, and analyze our traffic.
          By clicking "Accept", you consent to our use of cookies.
          <a href="/privacy-policy" class="text-primary hover:text-primary/80 underline ml-1 font-medium">
            Privacy Policy
          </a>
        </p>
      </div>
      <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
        <button
          id="cookie-decline"
          class="px-4 py-2 text-sm bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors duration-200 w-full sm:w-auto font-medium"
        >
          Decline
        </button>
        <button
          id="cookie-accept"
          class="px-4 py-2 text-sm bg-primary text-white border border-transparent rounded-md hover:bg-primary/90 transition-colors duration-200 w-full sm:w-auto font-medium"
        >
          Accept
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  import { initializeAnalytics, updateConsent } from '../utils/analytics';

  // TypeScript declarations for global objects
  declare global {
    interface Window {
      dataLayer: any[];
      gtag: (...args: any[]) => void;
    }
  }

  const CONSENT_COOKIE_NAME = 'cookieConsent';
  const CONSENT_DATE_KEY = 'cookieConsentDate';
  const ONE_YEAR_MS = 365 * 24 * 60 * 60 * 1000;

  const cookieBanner = document.getElementById('cookie-banner');

  /**
   * Get consent status from localStorage
   */
  function getConsentStatus(): 'accepted' | 'declined' | null {
    return localStorage.getItem(CONSENT_COOKIE_NAME) as 'accepted' | 'declined' | null;
  }

  /**
   * Check if consent is older than 1 year
   */
  function isConsentExpired(): boolean {
    const consentDate = localStorage.getItem(CONSENT_DATE_KEY);
    if (!consentDate) return true;

    const consentDateObj = new Date(consentDate);
    const oneYearAgo = new Date(Date.now() - ONE_YEAR_MS);

    return consentDateObj < oneYearAgo;
  }

  /**
   * Save consent choice to localStorage
   */
  function saveConsent(accepted: boolean) {
    const status = accepted ? 'accepted' : 'declined';
    localStorage.setItem(CONSENT_COOKIE_NAME, status);
    localStorage.setItem(CONSENT_DATE_KEY, new Date().toISOString());
  }

  /**
   * Show cookie banner
   */
  function showBanner() {
    if (cookieBanner) {
      cookieBanner.classList.remove('hidden');
      setTimeout(() => {
        cookieBanner.classList.remove('translate-y-full');
      }, 100);
    }
  }

  /**
   * Hide cookie banner
   */
  function hideBanner() {
    if (cookieBanner) {
      cookieBanner.classList.add('translate-y-full');
      setTimeout(() => {
        cookieBanner.classList.add('hidden');
      }, 300);
    }
  }

  /**
   * Handle accept button click
   */
  function handleAccept() {
    saveConsent(true);
    updateConsent(true);
    hideBanner();

    // Fire acceptance event
    if (window.gtag) {
      window.gtag('event', 'cookie_consent_accept', {
        'event_category': 'consent',
        'event_label': 'accepted',
        'timestamp': new Date().toISOString()
      });
    }
  }

  /**
   * Handle decline button click
   */
  function handleDecline() {
    saveConsent(false);
    updateConsent(false);
    hideBanner();

    // Fire decline event (will be limited by consent settings)
    if (window.gtag) {
      window.gtag('event', 'cookie_consent_decline', {
        'event_category': 'consent',
        'event_label': 'declined',
        'timestamp': new Date().toISOString()
      });
    }
  }

  /**
   * Initialize on page load
   */
  function init() {
    // Always initialize analytics (scripts load but respect consent)
    initializeAnalytics();

    const consentStatus = getConsentStatus();

    // Check if consent is expired
    if (consentStatus && isConsentExpired()) {
      localStorage.removeItem(CONSENT_COOKIE_NAME);
      localStorage.removeItem(CONSENT_DATE_KEY);
      showBanner();
      return;
    }

    // Apply existing consent
    if (consentStatus === 'accepted') {
      updateConsent(true);
    } else if (consentStatus === 'declined') {
      updateConsent(false);
    } else {
      // No consent given yet, show banner
      showBanner();
    }
  }

  // Event listeners
  document.getElementById('cookie-accept')?.addEventListener('click', handleAccept);
  document.getElementById('cookie-decline')?.addEventListener('click', handleDecline);

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>